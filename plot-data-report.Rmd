---
title: "Fire-Plant Invasions-TBD"
date: "`r Sys.time()`"
output: 
   html_document:
     self_contained: no
     toc: yes
---

```{r set options, echo=F}
# knitr::opts_chunk$set(fig.height = 10)
knitr::opts_chunk$set(fig.width = 7.5)
knitr::opts_chunk$set(dpi = 300)
knitr::opts_chunk$set(echo = F)
knitr::opts_chunk$set(warning = F)
knitr::opts_chunk$set(message = F)
```

```{r load libraries}
# source(plot-data.R)

library(plyr); library(dplyr); library(ggplot2); library(readr)
library(stringi)
library(tidyr)

source("R_scripts/copy-raw-data-from-Dropbox.R")

rm(list=ls())

```

```{r assign global variables}

def_theme <- theme(legend.title = element_blank(),
            legend.text = element_text(size = 18),
            legend.position = "right",
            axis.text = element_text(size = 18),
            axis.title = element_text(size = 18),
            plot.title = element_text(size = 20),
            strip.background = element_blank(),
            panel.grid = element_blank()
            )
invasion_color <- scale_color_manual(values = c("blue","darkorange"))
invasion_fill <- scale_fill_manual(values = c("blue","darkorange"))

```


```{r plot data manipulation}
# plot_data <- read_csv("~/Dropbox (UF)/SERDP-Project/data/plot_info.csv")

# plot_locations <- rgdal::readOGR("data/plot-locations.shp", verbose = F)
# plot_data <- plot_locations@data
# plot_data$fire_year <- as.integer(as.character(plot_data$fire_year))
# plot_data$years_since_fire <- 2017 - plot_data$fire_year
# plot_data <- plot_data %>%
#       filter(is.na(fire_year)==FALSE) %>%
#       mutate(plot_id = tolower(stri_sub(name, -2,-1)),
#              installation = tolower(stri_sub(name,1,-3))) %>%
#       rename(last_fire_year = fire_year) %>% 
#       select(installation, plot_id, last_fire_year, years_since_fire, imcy_inv)


# plot_data <- read_csv("data/plot_data.csv")
plot_visit_data <- read_csv("data/raw_data/plot_visit.csv")
summary(plot_visit_data)
plot_visit_data <- mutate(
      plot_visit_data,
      years_since_fire = as.numeric(format(visit_date, "%Y")) - last_fire_year,
      pid = paste(installation,plot_id),
      visit_year = lubridate::year(visit_date)
      )

plot_visit_data <- filter(plot_visit_data, !is.na(last_fire_year))

sort(plot_visit_data$pid)

# plot_visit_data <- left_join(plot_visit_data, 
#                              plot_data)
# plot_visit_data <- plot_visit_data[is.na(plot_visit_data$visit_date)==FALSE,]
# plot_visit_data <- mutate(plot_visit_data, 
#                           pid = paste(installation,plot_id))
# length(unique(plot_visit_data$pid))
# plot_visit_data <- arrange(plot_visit_data, desc(ycoord_lat))
# 
# plot_visit_data %>% 
#       if_else(round(ycoord_lat, digits = 1)>31, 31, 0)

plot_visit_data <- filter(plot_visit_data, is.na(last_fire_year)==FALSE)

unique(plot_visit_data$installation)
## Add labels column for installation names
plot_visit_data$installation_full_name[plot_visit_data$installation=="blanding"] <- "Camp Blanding"
plot_visit_data$installation_full_name[plot_visit_data$installation=="eglin"] <- "Eglin AFB"
plot_visit_data$installation_full_name[plot_visit_data$installation=="tyndall"] <- "Tyndall AFB"
plot_visit_data$installation_full_name[plot_visit_data$installation=="avonpark"] <- "Avon Park AFR"
plot_visit_data$installation_full_name[plot_visit_data$installation=="shelby"] <- "Camp Shelby"
plot_visit_data$installation_full_name[plot_visit_data$installation=="moody"] <- "Moody AFB"
plot_visit_data$installation_full_name[plot_visit_data$installation=="jackson"] <- "Fort Jackson"
plot_visit_data$installation_full_name[plot_visit_data$installation=="benning"] <- "Fort Benning"

```

# Installations Visited and Plots Sampled

* **`r n_distinct(plot_visit_data$installation)` installations**
* **`r n_distinct(plot_visit_data$last_fire_year)` different years since fire**
* **`r n_distinct(plot_visit_data$pid)` different plots, some multiple times**

![](figures/DoD-installations-map2017.png)

```{r summary of plots visited, fig.width=10}

plot_visit_data$imcy_inv <- factor(plot_visit_data$imcy_inv, levels=c("uninvaded","invaded"), labels = c("Uninvaded","Invaded"))

# xtabs(~ imcy_inv + last_fire_year + installation_full_name, data = plot_visit_data)

# ggplot(plot_data, aes(installation)) +
#       geom_bar() +
#       ylab("Number of plots") +
#       ggtitle("Number of plots established at each installation") +
#       theme_classic()
# plot_data$inv_colors[plot_data$imcy_inv=="invaded"] <- "#d8b365"
# plot_data$inv_colors[plot_data$imcy_inv=="uninvaded"] <- "#5ab4ac"

ggplot(plot_visit_data, aes(installation_full_name,)) +
      geom_bar(fill = "blue") +
      # facet_grid(installation_full_name ~ ., scales = "free_y") +
      ylab("Number of sample points") +
      xlab("") +
      # ggtitle("Plots in Burn Units Across Installations") +
      theme_classic()
      
ggplot(plot_visit_data, aes(as.factor(years_since_fire))) +
      geom_bar(aes(fill = imcy_inv), position = "dodge") +
      invasion_fill +
      # scale_fill_discrete(h = c(249,200)) +
      ylab("Number of sample points") +
      xlab("Years since fire") +
      # ggtitle("Invaded vs. Uninvaded Plots Across Burn Units") +
      theme_classic() +
      def_theme +
      theme(legend.position = c(.8,.8))

ggplot(plot_visit_data, aes(as.factor(years_since_fire))) +
      geom_bar(aes(fill = imcy_inv), position = "dodge") +
      invasion_fill +
      facet_grid(installation_full_name~.) +
      ylab("Number of sample points") +
      xlab("Years since fire") +
      # ggtitle("Invaded vs. Uninvaded Plots Across Burn Units") +
      theme_bw() +
      def_theme +
      theme(legend.position = "top")

# ggplot(plot_data, aes(imcy_inv)) +
#       geom_bar() +
#       ylab("Number of plots") +
#       xlab("") +
#       ggtitle("Invaded plots: 8, Uninvaded plots: 21") +
#       theme_classic()

# ggplot(plot_visit_data, aes(ycoord_lat, years_since_fire)) +
#       geom_point(aes(color = installation, shape = imcy_inv), size = 2) +
#       # geom_bar(stat = "identity") +
#       theme_classic()

```


# Canopy Cover Data
```{r load canopy cover data}
canopy_cover <- read_csv("data/raw_data/densiometer-data.csv")
canopy_cover <- canopy_cover %>% 
      mutate(date = as.Date(as.character(date), format = "%Y%m%d"),
             visit_year = lubridate::year(date),
             pid = paste(installation, plot_id, sep = " "))

canopy_cover_summary <- canopy_cover %>%
      filter(distance == 10) %>% 
      group_by(installation, plot_id, pid, date, visit_year) %>%
      summarise(avg_canopy_cover = mean(pct_canopy_cover),
                sd_canopy_cover = sd(pct_canopy_cover),
                n_obs = length(pct_canopy_cover),
                se_canopy_cover = sd_canopy_cover/sqrt(n_obs))
summary(canopy_cover_summary)

cc_inv <- left_join(canopy_cover_summary, plot_visit_data)
# summary(cc_inv)
cc_inv <- filter(cc_inv, !is.na(years_since_fire))

ggplot(cc_inv, aes(years_since_fire, avg_canopy_cover)) +
      geom_point(aes(color = imcy_inv)) +
      # geom_smooth() +
      # geom_bar(aes(fill = imcy_inv), stat = "identity", position = "dodge") +
      invasion_color +
      # scale_fill_discrete(h = c(249,200)) +
      ylab("Overstory canopy cover (%)") +
      xlab("Years since last fire") +
      # ggtitle("Invaded vs. Uninvaded Plots Across Burn Units") +
      theme_classic() +
      theme(legend.title = element_blank())

# plot_data1 <- left_join(ungroup(plot_data), ungroup(canopy_cover_summary))
# plot_data1 <- left_join(ungroup(plot_data), ungroup(quadrat_summaries))
```


# Species Data - 1-meter Quadrats

```{r load 1m quadrat data}
quadrat_data <- read_csv("data/raw_data/quadrat1m.csv")
quadrat_data$date <- as.Date(as.character(quadrat_data$date), format = "%Y%m%d")
quadrat_data <- quadrat_data %>% 
      filter(date > "2017-06-01",# discard early data collection at Camp Blanding
      plot_id != "cogan" # discard movie theater cogon plot at Camp Blanding
      ) %>% 
      mutate(visit_year = lubridate::year(date),
             pid = paste(installation, plot_id, sep = " "))

# summary(quadrat_data)

quadrat_data$herb_veg_ht1 <- as.numeric(quadrat_data$herb_veg_ht1)
quadrat_data$herb_veg_ht2 <- as.numeric(quadrat_data$herb_veg_ht2)
quadrat_data$herb_veg_ht3 <- as.numeric(quadrat_data$herb_veg_ht3)

quadrat_data$woody_veg_ht1[is.na(quadrat_data$woody_veg_ht1)] <- 0
# quadrat_data$woody_veg_ht1 <- as.numeric(quadrat_data$woody_veg_ht1)
quadrat_data$herb_veg_ht1[is.na(quadrat_data$herb_veg_ht1)] <- 0
# quadrat_data$herb_veg_ht1 <- as.numeric(quadrat_data$herb_veg_ht1)
quadrat_data$pct_green[quadrat_data$pct_green=="<1"] <- 0.5
quadrat_data$pct_green <- as.numeric(quadrat_data$pct_green)

quadrat_data <- left_join(
      quadrat_data,
      plot_visit_data
)

quadrat10_data <- filter(
      quadrat_data, quadrat_id %in% c("e10","w10","n10","s10")
)

# summary(quadrat_data)
# filter(quadrat_data, is.na(years_since_fire))

```

```{r summarize 1m quadrat data across each plot}

quadrat10_summaries <- quadrat10_data %>%
      group_by(installation, plot_id, date, visit_year, pid) %>%
      summarise(
            avg_woody_ht1 = mean(woody_veg_ht1),
            avg_woody_ht_all = mean(
                  c(woody_veg_ht1,woody_veg_ht2,woody_veg_ht3), na.rm = T),
            avg_herb_ht1 = mean(herb_veg_ht1),
            avg_herb_ht_all = mean(c(herb_veg_ht1, herb_veg_ht2, herb_veg_ht3), na.rm = T),
            avg_litter_depth1 = mean(litter_ht1),
            avg_litter_depth_all =
                  mean(c(litter_ht1,litter_ht2,litter_ht3), na.rm = T),
            avg_pct_green = mean(pct_green),
            avg_pct_litter = mean(pct_litter),
            avg_pct_wood = mean(pct_wood_litter),
            avg_pct_bare = mean(pct_bare))

quadrat10_summaries <- left_join(
      quadrat10_summaries,
      plot_visit_data
)
summary(quadrat10_summaries)

herb_ht_fig <- ggplot(quadrat10_summaries, aes(years_since_fire, avg_herb_ht_all)) +
      geom_point(aes(color = imcy_inv), alpha = .5, size = 2) +
      # geom_jitter(aes(color = imcy_inv), alpha = .3) +
      invasion_color +
      theme_classic() +
      def_theme
      
woody_ht_fig <- ggplot(quadrat10_summaries, aes(years_since_fire, avg_woody_ht_all)) +
      geom_point(aes(color = imcy_inv), alpha = .5, size = 2) +
      # geom_jitter(aes(color = imcy_inv), alpha = .5, size = 2) +
      invasion_color +
      theme_classic() +
      def_theme

(litter_depth_fig <- ggplot(quadrat10_summaries, aes(years_since_fire, avg_litter_depth_all)) +
      # geom_point(aes(color = imcy_inv), alpha = .5, size = 2) +
      stat_summary(aes(color = imcy_inv), fun.data = "mean_se", geom = "pointrange") +
      # geom_jitter(aes(color = imcy_inv), alpha = .3) +
      invasion_color +
      theme_classic() +
      def_theme +
      xlab("Years since fire") +
      ylab("Litter depth (cm)")
)

(pct_litter_fig <- ggplot(quadrat10_summaries, aes(years_since_fire, avg_pct_litter)) +
      # geom_point(aes(color = imcy_inv), alpha = .5, size = 2) +
      stat_summary(aes(color = imcy_inv), fun.data = "mean_se", geom = "pointrange") +
      # geom_jitter(aes(color = imcy_inv), alpha = .3) +
      invasion_color +
      theme_classic() +
      def_theme +
      xlab("Years since fire") +
      ylab("Litter cover (%)")
)


pct_bare_fig <- ggplot(quadrat10_summaries, aes(years_since_fire, avg_pct_bare)) +
      geom_point(aes(color = imcy_inv), alpha = .5, size = 2) +
      # geom_jitter(aes(color = imcy_inv), alpha = .3) +
      invasion_color +
      theme_classic() +
      def_theme

```

```{r load species data}
species_data <- read_csv("data/raw_data/species1m.csv")
species_data <- select(species_data, Order:functional_group__1)
species_data$date <- as.Date(as.character(species_data$date), format = "%Y%m%d")
species_data <- species_data %>% 
      filter(date>"2017-06-01") %>% 
      mutate(pid = paste(installation, plot_id, sep = " "),
             visit_year = lubridate::year(date))

species_data$veg_id <- tolower(species_data$veg_id)

# species_data <- rename(species_data, sci_name = scientific_name)
str(species_data)
summary(species_data)

filter(species_data, is.na(pct_cover))
species_data$pct_cover[species_data$installation=="avonpark" & date=="2018-05-31" & species_data$plot_id=="f1" & species_data$quadrat_id=="n10" & veg_id=="xyca"] <- 4
species_data$pct_cover[species_data$installation=="avonpark" & date=="2018-05-29" & species_data$plot_id=="e2" & species_data$quadrat_id=="e10" & veg_id=="dicl"] <- 4

species_data$pct_cover[species_data$installation=="eglin" & date=="2018-06-11" & species_data$plot_id=="a1" & species_data$quadrat_id=="e10" & veg_id=="an"] <- NA

species_data$pct_cover[species_data$installation=="tyndall" & date=="2018-06-25" & species_data$plot_id=="d2" & species_data$quadrat_id=="n10" & veg_id=="dicl"] <- NA
      
species_data$pct_cover[species_data$installation=="tyndall" & date=="2018-06-25" & species_data$plot_id=="d2" & species_data$quadrat_id=="n10" & veg_id=="piel"] <- NA   
species_data$pct_cover[species_data$installation=="jackson" & date=="2018-07-12" & species_data$plot_id=="h1" & species_data$quadrat_id=="w10" & veg_id=="saal5"] <- NA    


# sort(unique(species_data$veg_id))
# species_data$scientific_name <- paste(species_data$Genus, species_data$Species, sep = " ")
is.na(unique(species_data$scientific_name))
filter(species_data, is.na(scientific_name))
sort(unique(species_data$scientific_name))
# filter(species_data, Species=="nana")

species_data$functional_group <- tolower(species_data$functional_group)
is.na(unique(species_data$functional_group))
filter(species_data, is.na(functional_group))

# species_table <- read_csv("data/plant_species_list.csv")
# species_table$species[is.na(species_table$species)] <- ""
# species_table$scientific_name <- paste(
#       species_table$genus, species_table$species, sep = " ")

# species_table %>% arrange(scientific_name)
# 
# length(unique(species_data$scientific_name))
# sort(unique(species_data$scientific_name))
# n_distinct(species_data$veg_id)
# sort(unique(species_data$veg_id))

# species_data <- left_join(species_data, species_table, by = c("veg_id"="code"))

# unique(species_data$scientific_name)
# dsub <- select(species_data, veg_id, scientific_name, pct_cover) %>% 
      # filter(scientific_name=="NA NA", pct_cover < 10)
# sort(unique(dsub$veg_id))
# filter(species_data, veg_id=="shrub 11:29")
# filter(species_data, veg_id=="tls")


# species_data$scientific_name[species_data$veg_id=="qula"] <- "Quercus laevis"
# species_data$scientific_name[species_data$veg_id=="wiregrass"] <- "Aristida stricta"
# species_data$scientific_name[species_data$veg_id=="limi"] <- "Licania michauxii"
# species_data$scientific_name[species_data$veg_id=="pipa"] <- "Pinus palustris"
# species_data$scientific_name[species_data$veg_id=="quni"] <- "Quercus nigra"
# species_data$scientific_name[species_data$veg_id=="rhco"] <- "Rhus copallinum"
# species_data$scientific_name[species_data$veg_id=="moce"] <- "Morella cerifera"
# species_data$scientific_name[species_data$veg_id=="qula2"] <- "Quercus laurifolia"
# species_data$scientific_name[species_data$veg_id=="quge"] <- "Quercus geminata"
# species_data$scientific_name[species_data$veg_id=="divi"] <- "Diospyros virginiana"
# species_data$scientific_name[species_data$veg_id=="quge"] <- "Quercus geminata"

# filter(species_data, veg_id=="sf" # scientific_name!="NA",
#        )

species_data <- left_join(species_data, plot_visit_data)
# summary(species_data)
      
species10_data <- species_data %>% 
      filter(quadrat_id %in% c("e10","w10","n10","s10"))

# species_sub <- (filter(species_data, quadrat_id %in% c("e10","w10","n10","s10")))
# n_distinct(species_sub$scientific_name)
# sort(unique(species_sub$scientific_name))
# summary(species_sub)

```

```{r summarize veg cover}

veg_cover_data <- species10_data %>% arrange(date) %>% 
      group_by(installation, date, plot_id, pid, visit_year, functional_group) %>% 
      summarise(
            avg_pct_cover = mean(pct_cover)
      )
veg_cover_data <- left_join(
      veg_cover_data,
      plot_visit_data
)
# summary(veg_cover_data)
# filter(veg_cover_data, is.na(imcy_inv))

fxgroup_cover_fig <- ggplot(filter(veg_cover_data, !is.na(last_fire_year)), 
       aes(years_since_fire, avg_pct_cover)) +
      geom_point(aes(color = imcy_inv), alpha = .2) +
      stat_summary(fun.data = "mean_se", geom = "pointrange") +
      # geom_smooth() +
      invasion_color +
      facet_grid(.~installation_full_name) +
      theme_bw() +
      def_theme +
      theme(legend.position = "top")
      
```


## Understory vegetation cover
```{r average species cover, fig.height=9}

# datac$se <- datac$sd / sqrt(datac$N)
# species_data$imcy_inv <- factor(species_data$imcy_inv, levels = c("uninvaded","invaded"))

## Create data frame of vegetation cover averaged across plots, burn units, and installations
avg_species_cover <- species_data %>%
             group_by(installation_full_name, visit_year, plot_id, pid, imcy_inv, years_since_fire, quadrat_id) %>%
      summarise(veg_cover = sum(pct_cover, na.rm = T)) %>% 
      ungroup(.) %>% 
      group_by(installation_full_name, imcy_inv, years_since_fire) %>%
             summarise(avg_veg_cover = mean(veg_cover, na.rm = T),
                       # n_obs = length(veg_id),
                       max_veg_cover = max(veg_cover, na.rm = T),
                       se_veg_cover = sd(veg_cover, na.rm = T)/sqrt(length(veg_cover)))
summary(avg_species_cover)
avg_species_cover <- filter(avg_species_cover, !is.na(years_since_fire))

(veg_cover_fig <- ggplot(avg_species_cover,
      aes(as.factor(years_since_fire), avg_veg_cover)) +
      # geom_bar(aes(fill = imcy_inv), stat = "identity", position = "dodge") +
      geom_errorbar(aes(ymin = avg_veg_cover + se_veg_cover, ymax = avg_veg_cover - se_veg_cover), width = 0, position=position_dodge(width = .9)) +
      geom_point(aes(color = imcy_inv)) +
      invasion_fill +
      invasion_color +
      facet_grid(installation_full_name~.) +
      theme_bw() +
      ylab("Vegetation cover (%)") +
      xlab("Years since fire") +
      ggtitle("Herbaceous vegetation cover from 1-meter quadrats") +
      # def_theme +
      theme(legend.title = element_blank(),
            strip.background = element_blank())
)

# ggsave("~/Dropbox (UF)/SERDP-Project/figures/avg-pct-cover-bars.png", height = 7)

```


## Understory species richness
```{r species richness}

species_richness <- species_data %>%
      group_by(installation, years_since_fire, imcy_inv, pid) %>%
      summarise(richness = n_distinct(veg_id)) %>% 
      mutate(ln_richness = log(richness))

species10_richness <- species_data %>%
      filter(quadrat_id %in% c("w10","n10","e10","s10")) %>% 
      group_by(installation, years_since_fire, imcy_inv, pid) %>%
      summarise(richness = n_distinct(veg_id)) %>% 
      mutate(ln_richness = log(richness))

invaded_quadrats <- species_data %>% 
      filter(scientific_name=="Imperata cylindrica") %>% 
      mutate(quadrat_invaded = "yes") %>% 
      select(installation:quadrat_id, quadrat_invaded, years_since_fire, installation_full_name)

species_data <- left_join(species_data, invaded_quadrats)
species_data$quadrat_invaded[is.na(species_data$quadrat_invaded)] <- "no"

quadrat_species_richness <- species_data %>%
      group_by(installation_full_name, years_since_fire, quadrat_invaded, quadrat_id) %>%
      summarise(richness = length(unique(veg_id))) %>% 
      mutate(ln_richness = log(richness),
             invasion_status = factor(quadrat_invaded, levels = c("no","yes"), labels = c("Uninvaded","Invaded")))

quadrat10_richness <- quadrat_species_richness %>% 
      filter(quadrat_id %in% c("e10","n10","s10","w10"))

```

There were `r length(invaded_quadrats$quadrat_invaded)` (`r round(100*length(invaded_quadrats$quadrat_invaded)/length(quadrat_species_richness$richness), digits = 1)` %) 1-m quadrats located in invaded areas representing `r n_distinct(invaded_quadrats$years_since_fire)` different years since fire at `r n_distinct(invaded_quadrats$installation)` different installations (`r unique(invaded_quadrats$installation_full_name)`).

```{r quadrat richness}

## All points
# ggplot(quadrat_species_richness, aes(years_since_fire, richness, color = invasion_status)) +
#       # geom_boxplot(notch = F) +
#       geom_point(position = "jitter") +
#       invasion_color +
#       invasion_fill +
#       geom_smooth(show.legend = F, alpha = .2, aes(fill = invasion_status)) +
#       # facet_grid(.~installation) +
#       theme_classic() +
#       xlab("") +
#       ylab("Richness") +
#       ggtitle("Quadrat-level species diversity")


(quadrat_richness_fig <- ggplot(quadrat10_richness, aes(years_since_fire, richness, color = invasion_status)) +
      # geom_boxplot(aes(fill = quadrat_invaded), position = "dodge") +
      geom_point(aes(color = invasion_status), alpha = .5, size = .5) +
      geom_smooth(show.legend = F, alpha = .2, aes(fill = invasion_status)) +
      # stat_summary(fun.y = "mean", geom = "point") +
      stat_summary(fun.data = "mean_se", geom = "pointrange", alpha = .7) +
      invasion_color +
      invasion_fill +
      theme_classic() +
      def_theme +
      ylab("Richness") +
      xlab("Years since fire") +
      ggtitle("1m quadrat understory species diversity") +
      theme(legend.position = c(.8,.8))
)

```


```{r plot richness}

(plot_richness_fig <- ggplot(species_richness, aes(years_since_fire, richness, color = imcy_inv)) +
      # geom_boxplot(aes(fill = quadrat_invaded), position = "dodge") +
      geom_point(aes(color = imcy_inv), alpha = .5, size = .5) +
      geom_smooth(show.legend = F, alpha = .2, aes(fill = imcy_inv)) +
      # stat_summary(fun.y = "mean", geom = "point") +
      stat_summary(fun.data = "mean_se", geom = "pointrange", alpha = .7) +
      invasion_color +
      invasion_fill +
      theme_classic() +
      def_theme +
      ylab("Richness") +
      xlab("Years since fire") +
      ggtitle("Plot understory species diversity") +
      theme(legend.position = c(.8,.8))
)

(plot10_richness_fig <- ggplot(species10_richness, aes(years_since_fire, richness, color = imcy_inv)) +
      # geom_boxplot(aes(fill = quadrat_invaded), position = "dodge") +
      geom_point(aes(color = imcy_inv), alpha = .5, size = .5) +
      geom_smooth(show.legend = F, alpha = .2, aes(fill = imcy_inv)) +
      # stat_summary(fun.y = "mean", geom = "point") +
      stat_summary(fun.data = "mean_se", geom = "pointrange", alpha = .7) +
      invasion_color +
      invasion_fill +
      theme_classic() +
      def_theme +
      ylab("Richness") +
      xlab("Years since fire") +
      ggtitle("Plot understory species diversity") +
      theme(legend.position = c(.8,.8))
)



plot_fxgroups <- species_data %>% 
      filter(functional_group=="graminoid"|functional_group=="forb"|functional_group=="tree"|functional_group=="shrub") %>% 
      filter(quadrat_id %in% c("e10","n10","s10","w10")) %>% 
      group_by(installation, years_since_fire, imcy_inv, plot_id, functional_group) %>% 
      summarise(fxgroup_abundance = length(unique(veg_id)))

ggplot(plot_fxgroups, 
       aes(years_since_fire, fxgroup_abundance, color = functional_group)) +
      stat_summary(fun.data = "mean_se", geom = "pointrange") +
      geom_point(position = "jitter", alpha = .3) +
      # geom_smooth(alpha = .1, aes(color = functional_group)) +
      # invasion_color +
      theme_classic() +
      xlab("Years since fire") +
      ylab("Richness") +
      ggtitle("Functional group diversity") 

```

There is no clear effect of cogongrass invasion on diversity in these data, however, the representation of invasion is very small within each time since fire grouping. In two cases we have only a single sampling point, so no estimate of variation. We do see a non-linear relationship with the time since last fire, where richness is initially highest a few months following a fire, then decreases for 1-2 years before increasing small amount and then declining again after about 6 years after the last fire.

```{r 5pct species cover, eval=F}

species_over_5pct <- filter(species_data, pct_cover>5)
# species_sub_over_5pct <- filter(species_sub_over_5pct, cogongrass != "NA")
summary(species_over_5pct)
species_over_5pct <- filter(species_over_5pct, !is.na(years_since_fire))

ggplot(species_over_5pct,
       aes(years_since_fire, pct_cover, color = veg_id)) +
      geom_point() +
      theme_classic() +
      def_theme +
      facet_grid(installation~imcy_inv) +
      ylab("% cover") +
      xlab("Years since fire") +
      ggtitle("Range of species cover (>5%) at 1-meter quadrats")
# ggsave("~/Dropbox (UF)/SERDP-Project/figures/species-pct-cover.png", height = 7)

```

# Tree Data

```{r load tree data, results='hide'}

tree_data <- read_csv("data/raw_data/trees.csv")
# tree_data
tree_data$date <- as.Date(as.character(tree_data$date), format = "%Y%m%d")
tree_data$plot_id <- tolower(tree_data$plot_id)

tree_data <- tree_data %>% 
      filter(
            date>"2017-06-01",
            plot_id != "bland03", plot_id != "bland02", plot_id != "cogon plot") %>% 
      rename(tree_id = species) %>% 
      mutate(visit_year = lubridate::year(date),
             pid = paste(installation, plot_id, sep = " "))
summary(tree_data)

      
# unique(tree_data$plot_id)

tree_data <- left_join(
      tree_data,
      select(plot_visit_data, -notes)) %>% 
      mutate(genus = "", species = "", labels = "")

sort(unique(tree_data$tree_id))
tree_data$tree_id <- tolower(tree_data$tree_id)

tree_data$tree_id[tree_data$tree_id=="blackjack"|tree_data$tree_id=="blackjack oak"] <- "quma"
tree_data$tree_id[tree_data$tree_id=="divi"] <- "divi5"
tree_data$tree_id[tree_data$tree_id=="cr"] <- "hawthorn"
tree_data$tree_id[tree_data$tree_id %in% c("hicking","hickoru","hickory")] <- "carya"
tree_data$tree_id[tree_data$tree_id=="laurel oak"] <- "quhe2"
tree_data$tree_id[tree_data$tree_id %in% c("oak?","qu?","quercus")] <- "quspp"
tree_data$tree_id[tree_data$tree_id %in% c("n.red oak","quercus ruba")] <- "quru"
tree_data$tree_id[tree_data$tree_id %in% c("piap2","pipa")] <- "pipa2"
tree_data$tree_id[tree_data$tree_id=="quhe"] <- "quhe2"
tree_data$tree_id[tree_data$tree_id=="quge"] <- "quge2"
tree_data$tree_id[tree_data$tree_id %in% c("sweetgum","sweet gum","")] <- "list2"
tree_data$tree_id[tree_data$tree_id=="qvni"] <- "quni"
tree_data$tree_id[tree_data$tree_id=="tree shrub?"] <- "unknown"
tree_data$tree_id[tree_data$tree_id=="tuip poplar"] <- "litu"
tree_data$tree_id[tree_data$tree_id=="white"] <- "white oak"
tree_data$tree_id[tree_data$tree_id %in% c("pinus","pi","pisp")] <- "pispp"
tree_data$tree_id[tree_data$tree_id=="post oak"] <- "qust"


tree_data$genus[tree_data$tree_id=="acru"] <- "Acer"
tree_data$genus[tree_data$tree_id=="bay"] <- "Persea"
tree_data$genus[tree_data$tree_id=="carya"] <- "Carya"
tree_data$genus[tree_data$tree_id=="divi5"] <- "Diospyros"
tree_data$genus[tree_data$tree_id=="hawthorn"] <- "Crataegus"
tree_data$genus[tree_data$tree_id=="ilvo"] <- "Ilex"
tree_data$genus[tree_data$tree_id=="list2"] <- "Liquidambar"
tree_data$genus[tree_data$tree_id=="litu"] <- "Liriodendron"
tree_data$genus[tree_data$tree_id=="magnolia"] <- "Magnolia"
tree_data$genus[tree_data$tree_id=="sassafras"] <- "Sassafras"
tree_data$genus[tree_data$tree_id=="tupelo"] <- "Nyssa"
tree_data$genus[tree_data$tree_id=="vaccinium"] <- "Vaccinium"

tree_data$genus[agrep("qu", tree_data$tree_id, max.distance = 0)] <- "Quercus"
tree_data$genus[agrep("pi", tree_data$tree_id, max.distance = 0)] <- "Pinus"
# tree_data$genus[is.na(tree_data$tree_id)] <- "Unknown (dead)"
tree_data$labels <- tree_data$genus
tree_data$labels[!(tree_data$labels %in% c("Quercus","Pinus"))] <- "Other"

tree_data$imcy_inv <- factor(tree_data$imcy_inv, levels = c("Uninvaded","Invaded"))

summary(tree_data)
filter(tree_data, is.na(years_since_fire))
# skimr::skim(tree_data)


tree_grp_summary <- tree_data %>% 
      group_by(pid, labels, years_since_fire, imcy_inv, visit_year) %>% 
      summarise(
            total_dbh_cm = sum(dbh),
            avg_dbh_cm = mean(dbh),
            n_stems = length(stem_id))

tree_data_plot_summary <- tree_data %>% 
      group_by(pid, years_since_fire, imcy_inv, visit_year, installation_full_name) %>% 
      summarise(
            total_dbh = sum(dbh),
            richness = n_distinct(tree_id),
            avg_tree_ht = mean(height, na.rm = T),
            avg_char_ht = mean(char, na.rm = T))

tree_data_plot_summary <- left_join(
      tree_data_plot_summary,
      tree_grp_summary %>% 
            select(-avg_dbh_cm, -n_stems) %>% 
            spread(labels, total_dbh_cm) %>% 
            mutate(Quercus = if_else(is.na(Quercus)==TRUE,0,Quercus),
                   Pinus = if_else(is.na(Pinus)==TRUE,0,Pinus),
                   Other = if_else(is.na(Other)==TRUE,0,Other))
      ) %>%
      mutate(pct_pinus_dbh = 100*(Pinus/total_dbh))

skimr::skim(ungroup(tree_data_plot_summary))

```

## Tree richness
```{r tree richness}

# tree_richness <- tree_data %>% 
#       group_by(installation_full_name, years_since_fire, imcy_inv, pid) %>% 
#       summarise(richness = n_distinct(species)) %>% 
#       filter(!is.na(imcy_inv))

(tree_richness_fig <- ggplot(tree_data_plot_summary, 
       aes(years_since_fire, richness, color = imcy_inv)) +
      stat_summary(fun.data = "mean_se", geom = "pointrange") +
      # geom_point(position = position_jitter(height = .1, width = .3)) +
      invasion_color +
      invasion_fill +
      # facet_grid(installation_full_name~.) +
      theme_classic() +
      def_theme +
      ylab("Richness") +
      xlab("Years since fire") +
      ggtitle("Tree diversity vs. time since fire")
)

```

## Tree basal area
```{r tree basal area}

# plot_basal_area <- tree_data %>%
#       group_by(installation_full_name, labels, years_since_fire, plot_id) %>%
#       mutate(basal_area_ha = (pi*((.5*dbh/100)^2))/.05) %>% 
#       summarise(total_basal_area_ha = sum(basal_area_ha))
# 
# basal_area_data <- tree_data %>%
#       group_by(installation_full_name, labels, years_since_fire) %>%
#       mutate(basal_area_ha = (pi*((.5*dbh/100)^2))/.05) %>% 
#       summarise(total_basal_area_ha = sum(basal_area_ha),
#                 avg_basal_area_ha = mean(basal_area_ha),
#                 se_basal_area_ha = sd(basal_area_ha)/sqrt(length(basal_area_ha)))

(tree_dbh_fig <- ggplot(tree_data_plot_summary, 
       aes(years_since_fire, total_dbh, color = imcy_inv)
       ) +
      stat_summary(fun.data = "mean_se", geom = "pointrange", position = "jitter") +
      invasion_color +
      # geom_point(aes(color = labels)) +
      # geom_smooth(aes(color = labels), linetype = "dashed", se = F) +
      # geom_violin(aes(labels, dbh, fill = labels)) +
      # geom_dotplot(aes(labels, dbh, fill = labels),
      #            binaxis = "y",         # which axis to bin along
      #            binwidth = 0.4,       # Minimal difference considered different
      #            stackdir = "center"    # Centered
      #            ) +
      # geom_bar(aes(fill = labels), stat = "identity", position = "dodge") +
      # geom_errorbar(aes(ymin = avg_basal_area_ha + se_basal_area_ha, ymax = avg_basal_area_ha - se_basal_area_ha), width = .2, position = position_dodge(width = .5)) +
      # scale_color_brewer(palette = "Dark2") +

      # facet_grid(installation_full_name~.) +
      theme_classic() +
      # theme_bw() +
      xlab("Years since fire") +
      # ylab(expression(paste("Basal Area (", m^{2}, " ", ha^{-1}, ")"))) +
      ylab("DBH (cm)") +
      ggtitle("Total tree DBH across plots") +
      def_theme
)

```

```{r proportion pine dbh}

(pct_pine_fig <- ggplot(tree_data_plot_summary, 
       aes(years_since_fire, pct_pinus_dbh, color = imcy_inv)
       ) +
      stat_summary(fun.data = "mean_se", geom = "pointrange", position = "jitter") +
      invasion_color +
      # facet_grid(installation_full_name~.) +
      theme_classic() +
      # theme_bw() +
      xlab("Years since fire") +
      # ylab(expression(paste("Basal Area (", m^{2}, " ", ha^{-1}, ")"))) +
      ylab("Percent pine DBH ") +
      # ggtitle("Total tree DBH across plots") +
      def_theme
)

```

## Tree dbh
```{r tree dbh, eval = F}

ggplot(tree_data %>%
             filter(!is.na(imcy_inv)) %>% 
             group_by(installation_full_name, labels, years_since_fire, imcy_inv),
       aes(as.factor(years_since_fire), dbh, color = labels)) +
      geom_point(position = "jitter") +
      scale_fill_brewer(palette = "Dark2") +
      scale_color_brewer(palette = "Dark2") +
      facet_grid(installation_full_name~imcy_inv) +
      theme_bw() +
      xlab("Years since fire") +
      ylab("Diameter at breast height") +
      def_theme +
      theme(strip.background = element_blank(),
            panel.grid = element_blank())
# ggsave("~/Dropbox (UF)/SERDP-Project/figures/tree-dbh-jitter.png", height=7)
```

## Tree height
```{r tree height, eval = F}
# tree_height <- tree_data %>%
#       group_by(installation_full_name, labels, years_since_fire, imcy_inv) 

ggplot(tree_data %>% 
             filter(!is.na(imcy_inv)),
       aes(years_since_fire, height, color = labels)) +
      # stat_summary(fun.data = "mean_se", geom = "pointrange") +
      geom_point(position = "jitter") +
      scale_color_brewer(palette = "Dark2") +
      facet_grid(installation_full_name~imcy_inv) +
      theme_bw() +
      xlab("Years since fire") +
      ylab("Tree height") +
      def_theme
# ggsave("~/Dropbox (UF)/SERDP-Project/figures/tree-height-jitter.png", height=7)

```

```{r char height}
tree_data_plot_summary
ggplot(tree_data_plot_summary,
       aes(imcy_inv, avg_char_ht, fill = imcy_inv, color = imcy_inv)) +
      stat_summary(fun.data = "mean_se", geom = "pointrange") +
      # geom_point(position = "jitter") +
      # geom_bar(stat = "identity", position = "dodge") +
      invasion_color +
      invasion_fill +
      # facet_grid(installation_full_name~.) +
      # theme_bw() +
      theme_classic() +
      xlab("") +
      ylab("Char height (m)") +
      def_theme

```


# Sub-plot sapling/shrub data

```{r 100m subplot, results='hide'}

subplot_data <- read_csv("data/raw_data/subplot-woody-species.csv")
subplot_data$date <- as.Date(as.character(subplot_data$date), format="%Y%m%d")
subplot_data$plot_id <- tolower(subplot_data$plot_id)
subplot_data$installation[subplot_data$installation=="avon"] <- "avonpark"

subplot_data <- subplot_data %>% 
      select(-under_50cm,-`50-99cm`) %>% 
      filter(date >"2017-06-01") %>% 
      mutate(stems_100m2 = round(if_else(date<"2018-01-01", over_100cm*.599,over_100cm*1)),
             visit_year = lubridate::year(date),
             pid = paste(installation, plot_id, sep = " "))

subplot_data <- left_join(
      subplot_data,
      select(plot_visit_data, -notes)
)

# summary(subplot_data)
# filter(subplot_data, is.na(years_since_fire))

subplot_plot_summary <- subplot_data %>% 
      group_by(pid, visit_year, imcy_inv, years_since_fire, installation_full_name) %>% 
      summarise(shrub_sap_rich = n_distinct(veg_id),
                total_stems_100m2 = sum(stems_100m2))
summary(subplot_plot_summary)

```

```{r subplot figure}

(shrub_saplings_fig <- ggplot(subplot_data, aes(years_since_fire, stems_100m2, color = imcy_inv)) +
      stat_summary(fun.data = "mean_se", geom = "pointrange") +
      # geom_point(aes(color = imcy_inv)) +
      invasion_color +
      # facet_grid(.~veg_id) +
      theme_classic() +
      def_theme +
      ggtitle("Shrub & sapling stem density") +
      xlab("Years since fire") +
      ylab(expression(paste("Stem density (100 ", {m}^-2,")")))
)

```


# Biomass data sampled at 25cm quadrats

Biomass is averaged across the four 25 cm quadrats for each plot, and then these values are summarized in the figures across the roughly estimated years since fire. 

```{r 25cm biomass data, results='hide'}

biomass_data <- read_csv("data/raw_data/quadrat25cm.csv")
biomass_data$date <- as.Date(as.character(biomass_data$date), format="%Y%m%d")
biomass_data <- filter(biomass_data, date>"2017-04-25", plot_id!="bland02", plot_id!="bland03")
# summary(biomass_data)

biomass_data <- biomass_data %>% 
      mutate(pct_litter_moisture = 100*(litter_mass_wet-litter_mass_dry)/litter_mass_wet,
             pid = paste(installation, plot_id, sep = " "),
             visit_year = lubridate::year(date))

biomass_data <- left_join(
      biomass_data,
      select(plot_visit_data, -notes))
summary(biomass_data)

filter(biomass_data, is.na(imcy_inv))

# biomass_data$last_fire_year <- as.integer(biomass_data$last_fire_year)
# biomass_data$years_since_fire <- 2017 - biomass_data$last_fire_year

biomass_plot_summary <- biomass_data %>% 
      group_by(pid, visit_year, years_since_fire, imcy_inv, installation_full_name) %>% 
      mutate(standing_gm2 = standing_fuel_mass_wet*16,
             litter_gm2 = litter_mass_wet*16,
             dry_standing_gm2 = standing_fuel_mass_dry*16,
             dry_litter_gm2 = litter_mass_dry*16) %>% 
      summarise(avg_dry_standing_gm2 = mean(dry_standing_gm2),
                se_dry_standing_gm2 = sd(dry_standing_gm2)/sqrt(length(dry_standing_gm2)),
                avg_dry_litter_gm2 = mean(dry_litter_gm2),
                se_litter = sd(dry_litter_gm2)/sqrt(length(dry_litter_gm2)),
                avg_pct_litter_moisture = mean(pct_litter_moisture))
summary(biomass_plot_summary)

biomass_plot_summary <- filter(biomass_plot_summary, !is.na(years_since_fire))
# filter(biomass_plot_summary, is.na(se_litter))
```

```{r standing biomass fig}

(stand_biomass_fig <- ggplot(biomass_plot_summary,
       aes(years_since_fire, avg_dry_standing_gm2, color = imcy_inv)) +
      # geom_point() +
      stat_summary(fun.data = "mean_se", geom = "pointrange") +
      invasion_color +
      invasion_fill +
      # facet_grid(.~installation) +
      # geom_smooth(aes(fill = imcy_inv), se = T, alpha = .1) +
      theme_classic() +
      ylab(expression(paste("Standing biomass (g ", m^{-2}, ")"))) +
      xlab("Years since last fire") +
      ggtitle("Dry standing biomass",
              subtitle = "(measurements at 25cm quadrats)") +
      theme(legend.title = element_blank()) +
      def_theme
)

# ggsave("~/Dropbox (UF)/SERDP-Project/figures/standing-biomass-hitter.png", height=7)

```

```{r litter biomass fig}

(litter_mass_fig <- ggplot(biomass_plot_summary,
        aes(years_since_fire, avg_dry_litter_gm2, color = imcy_inv)) +
      geom_point(alpha = .2) +
      stat_summary(fun.data = "mean_se", geom = "pointrange") +
      invasion_color +
      invasion_fill +
      # geom_smooth(aes(fill = imcy_inv), se = T, alpha = .1) +
      # facet_grid(.~installation) +
      theme_classic() +
      ylab(expression(paste("Litter biomass (g ", m^{-2}, ")"))) +
      xlab("Years since last fire") +
      ggtitle("Dry litter biomass",
              subtitle = "(measurements at 25cm quadrats)") +
      def_theme
)

# ggsave("~/Dropbox (UF)/SERDP-Project/figures/litter-biomass-jitter.png", height=7)

```


# Host Abundance Estimates

```{r dung data, results='hide'}

dung_data <- read_csv("data/raw_data/dung.csv")
dung_data$plot_id <- tolower(dung_data$plot_id)
dung_data$species <- tolower(dung_data$species)
dung_data$location <- tolower(dung_data$location)
dung_data$date <- as.Date(as.character(dung_data$date), format="%Y%m%d")
summary(dung_data)
filter(dung_data, is.na(species), dung1m>0 | dung2m>0)

dung_data <- dung_data %>% 
      mutate(visit_year = lubridate::year(date),
             pid = paste(installation, plot_id, sep = " "))
# sort(unique(dung_data$pid))
filter(dung_data, is.na(dung1m))

dung_data <- left_join(select(plot_visit_data, -notes),
                       dung_data)
summary(dung_data)
filter(dung_data, is.na(dung1m))

# dung_data <- rename(dung_data, clusters1m = `1m`, clusters2m = `2m`)
dung_plot_avg_data <- dung_data %>% 
      group_by(installation, plot_id, visit_year, years_since_fire, imcy_inv) %>% 
      summarise(avg_clusters1m = mean(dung1m, na.rm = T),
                avg_clusters1m_2m = mean(rowSums(cbind(dung1m,dung2m)))
                )
summary(dung_plot_avg_data)
# skimr::skim(dung_data_avg)

```

```{r dung species figure}

(dung_species_fig <- ggplot(filter(dung_data, dung1m>0), aes(years_since_fire, log1p(dung1m))) +
      # geom_bar(aes(fill = imcy_inv), stat = "identity", position = "dodge") +
      geom_point(aes(color = species), size = 2, position = "jitter") +
      # geom_smooth(aes(color = species)) +
      invasion_fill +
      # invasion_color +
      # geom_smooth(aes(linetype = imcy_inv), se = F, alpha = .1) +
      # geom_smooth(aes(fill = imcy_inv), se = F, alpha = .1, method = "lm") +
      theme_classic() +
      ylab("log(Number of dung clusters)") +
      xlab("Years since fire") +
      # ylab("Dung clusters") +
      def_theme
)

```

```{r dung plot avg figure}

dung_plot_avg_data_noNA <- filter(dung_plot_avg_data, !is.na(avg_clusters1m))

(dung_plot_avg_fig <- ggplot(
      dung_plot_avg_data_noNA, 
      aes(years_since_fire, log1p(avg_clusters1m), color = imcy_inv)) +
      geom_point(size = 1, position = "jitter", alpha = .3) +
      stat_summary(fun.data = "mean_se", geom = "pointrange") +
      # geom_bar(aes(fill = imcy_inv), stat = "identity", position = "dodge") +
      # geom_smooth(aes(color = species)) +
      invasion_fill +
      invasion_color +
      # geom_smooth(aes(linetype = imcy_inv), se = F, alpha = .1) +
      # geom_smooth(aes(fill = imcy_inv), se = F, alpha = .1, method = "lm") +
      theme_classic() +
      ylab("log(Number of dung clusters)") +
      xlab("Years since fire") +
      # ylab("Dung clusters") +
      def_theme +
      theme(legend.position = c(.8,.9))      
)
      
```

# Tick Abundance

```{r tick data QC, results='hide'}

tick_data <- read_csv("data/raw_data/ticks.csv")
tick_data$plot_id <- tolower(tick_data$plot_id)
tick_data$location <- tolower(tick_data$location)
tick_data$species <- tolower(tick_data$species)
sort(unique(tick_data$plot_id))
sort(unique(tick_data$installation))
sort(unique(tick_data$species))

tick_data$plot_id[tick_data$plot_id=="c"] <- "c1"
# tick_data$Date <- as.Date(tick_data$Date, format = "%Y-%m-%d-")
# tick_data$excel_date <- gsub("-","",tick_data$date)
# write_csv(tick_data, "data/tick-data.csv")
tick_data$date <- as.Date(as.character(tick_data$date),format = "%Y%m%d")
summary(tick_data)

tick_data <- tick_data %>% 
      mutate(visit_year = lubridate::year(date),
             pid = paste(installation, plot_id))

tick_data <- left_join(tick_data, 
                       select(plot_visit_data, -notes))

# summary(tick_data)
filter(tick_data, is.na(years_since_fire))
filter(tick_data, is.na(imcy_inv))
# "extra" ticks at Moody AFB were from an area last burned in 2005
# tick_data$years_since_fire[tick_data$installation=="moody"] <- 2017-2005
# tick_data <- tick_data[is.na(tick_data$years_since_fire)==FALSE,]
# tick_data$installation_full_name[tick_data$installation=="moody"] <- "Moody AFB"

# tick_data$date <- as.Date(as.character(tick_data$date), format = "%Y%m%d")

```

## Total ticks collected across burn units 

The high tick abundance for 8-years post-fire is driven by a single plot at Camp Blanding.

```{r tick vs fire figure}

ggplot(tick_data %>% 
             filter(!is.na(imcy_inv), !is.na(life_stage)), 
       aes(years_since_fire, log1p(count), color = imcy_inv)) +
      # geom_bar(fill = "white", stat = "identity", position = "dodge", show.legend = F) +
      geom_point(alpha = .3, position = "jitter", size = .5) +
      stat_summary(fun.data = "mean_se", geom = "pointrange") +
      invasion_color +
      invasion_fill +
      # geom_violin(aes(fill = imcy_inv)) +
      # geom_dotplot(aes(fill = imcy_inv),
      #            binaxis = "y",         # which axis to bin along
      #            binwidth = .2,       # Minimal difference considered different
      #            stackdir = "center"    # Centered
      #            ) +
      facet_grid(life_stage~., scales = "free_y") +
      xlab("Years since fire") +
      ylab("log(tick abundance)") +
      # theme_classic() +
      theme_bw() +
      def_theme
      # theme(legend.position = c(.88,.88))

# ggplot(tick_data, aes(as.factor(years_since_fire), count)) +
#       stat_summary(fun.data = "mean_se",geom = "pointrange") +
#       xlab("Years since fire") +
#       ylab("Tick abundance") +
#       theme_classic() +
#       def_theme

```

## Tick species

**Note the different scales of the y-axes**

```{r tick-species-fig, fig.height=9}

ggplot(tick_data %>%
             group_by(installation_full_name, years_since_fire, species) %>%
             summarise(tick_number = sum(count)),
       aes(as.factor(years_since_fire), tick_number, fill = species)) +
      # geom_point(position = "jitter") +
      geom_bar(stat = "identity", position = "dodge") +
      scale_fill_brewer(palette = "Set1") +
      facet_grid(installation_full_name~., scales = "free_y") +
      xlab("Years since fire") +
      ylab("Tick abundance") +
      theme_bw() +
      def_theme

```

```{r summarize-tick-abundance-data}
tick_data_plot_summary <- tick_data %>% 
      group_by(pid, visit_year, years_since_fire, installation_full_name) %>% 
      summarise(total_ticks = sum(count))

biomass_data_sub <- ungroup(avg_biomass_data) %>% 
      select(installation:avg_litter_gm2)

# plot_data
# tick_data_sum <- left_join(plot_visit_data, tick_data_sum)
# tick_data_sum$total_ticks[is.na(tick_data_sum$total_ticks)] <- 0
tick_data_sum <- left_join(tick_data_sum, biomass_data_sub)
tick_data_sum <- left_join(tick_data_sum, select(avg_species_cover, installation_full_name:max_veg_cover))
tick_data_sum <- left_join(tick_data_sum, quadrat_summaries)
tick_data_sum <- left_join(tick_data_sum, 
                select(canopy_cover_summary, installation:avg_canopy_cover)
                )
tick_data_sum <- left_join(tick_data_sum, select(dung_data_avg, installation:avg_clusters1m))

unique(tick_data_sum$installation_full_name)
unique(tree_data_summary$installation_full_name)
tick_data_sum <- left_join(tick_data_sum, tree_data_summary)

tick_data_sum$imcy_inv <- factor(tick_data_sum$imcy_inv, levels = c("Uninvaded","Invaded"), labels = c("Uninvaded","Invaded"))

# skimr::skim(tick_data_sum)
```


## Tick~fire log-linear relationship 
```{r tick-fire}

ggplot(tick_data_sum, aes(years_since_fire, log1p(total_ticks), color = imcy_inv)) +
      geom_point() +
      invasion_color +
      invasion_fill +
      geom_smooth(aes(fill = imcy_inv), se = F, method = "loess", alpha = .2) +
      # geom_smooth(aes(color = imcy_inv), method = "loess",
                  # linetype = "dashed", se = F) +
      theme_classic() +
      xlab("Years since fire") +
      ylab("Tick abundance (log)") +
      def_theme

```


## Seasonal sampling

```{r tick-abundance-by-date}

tick_data$week <- lubridate::week((tick_data$date))

              # group_by(date, installation_full_name) %>% 
             # summarise(abundance = sum(count))
       
ggplot(tick_data,
       aes(date, count, color = installation)) +
      geom_point(size = 2) +
      # stat_summary(fun.data = "mean_se", geom = "pointrange") +
      # geom_bar(aes(fill = installation_full_name), stat = "identity") +
      # scale_fill_brewer(type = "div") +
      scale_x_date(limits = c(as.Date("2017-06-06"),as.Date("2018-08-01")),
                   date_breaks = "1 month") +
      # geom_smooth() +
      theme_classic() +
      ylab("Tick abundance") +
      xlab("") +
      # def_theme +
      theme(legend.position = c(.8, .85),
            legend.background = element_rect(color="black"))
      
```



## Tick abundance vs. latitude

No relationship, which is expected, though our range of latitude is very small. I plan to use an actual climate variable in the model, e.g. PRISM 30-year normals, WorldClim, DayMet, or possibly data from local weather stations.

```{r tick-abundance-latitude, eval=F}

ggplot(tick_data_sum, aes(ycoord_lat, log1p(total_ticks), color = imcy_inv)) +
      geom_point(position = "jitter") +
      invasion_color +
      invasion_fill + 
      # geom_smooth(aes(fill = imcy_inv), se = F, alpha = .2, method = "lm") +
      geom_smooth(aes(color = imcy_inv), method = "loess",
                  linetype = "dashed", se = F) +
      theme_classic() +
      xlab("Latitude") +
      ylab("Tick Abundance") +
      def_theme

```


# Tick abundance vs. plot-level averages

## Understory vegetation cover
```{r tick-veg-cover}

ggplot(tick_data_sum, aes(avg_veg_cover, log1p(total_ticks), color = imcy_inv)) +
      geom_point() +
      invasion_color +
      invasion_fill +
      # geom_smooth(aes(fill = imcy_inv), se = F, alpha = .2, method = "lm") +
      geom_smooth(aes(color = imcy_inv), method = "loess",
                  linetype = "dashed", se = F) +
      theme_classic() +
      xlab("Average vegetation cover (%)") +
      ylab("Tick abundance") +
      def_theme

```


## Understory biomass 
Log-linear relationship, very noisy trends with many zeroes. 

```{r tick-veg-biomass}

ggplot(tick_data_sum, aes((avg_standing_gm2), log1p(total_ticks), color = imcy_inv)) +
      geom_point() +
      invasion_color +
      invasion_fill +
      geom_smooth(aes(fill = imcy_inv), se = F, alpha = .2, method = "loess") +
      theme_classic() +
      xlab(expression(paste("Average biomass (g/", m^{2}, ")"))) +
      ylab("Tick abundance (log)") +
      ggtitle("Understory standing biomass") +
      def_theme

# summary(glm(total_ticks ~ avg_standing_gm2, data = tick_data_sum, family = "quasipoisson"))

```


## Litter percent cover
```{r tick-litter-cover}

ggplot(tick_data_sum, aes(avg_pct_litter, log1p(total_ticks), color = imcy_inv)) +
      geom_point() +
      invasion_color +
      invasion_fill +
      geom_smooth(aes(fill = imcy_inv), se = F, alpha = .2, method = "loess") +
      theme_classic() +
      xlab(expression(paste("Litter cover (%)"))) +
      ylab("Tick abundance (log)") +
      def_theme

```


## Litter biomass
```{r tick-litter-mass}

ggplot(tick_data_sum, aes(avg_litter_gm2, log1p(total_ticks), color = imcy_inv)) +
      geom_point(position = "jitter") +
      invasion_color +
      invasion_fill +
      geom_smooth(aes(fill = imcy_inv), se = F, alpha = .2, method = "loess") +
      theme_classic() +
      xlab(expression(paste("Biomass (g/", m^{2}, ")"))) +
      ylab("Tick abundance (log)") +
      ggtitle("Litter biomass") +
      def_theme

```

## Canopy cover
Log-linear relationship, where there are more ticks in plots with more canopy cover.
```{r tick-canopy-cover}

ggplot(tick_data_sum, aes(avg_canopy_cover, log1p(total_ticks), color = imcy_inv)) +
      geom_point() +
      invasion_color +
      invasion_fill +
      geom_smooth(aes(fill = imcy_inv), se = F, alpha = .2, method = "loess") +
      theme_classic() +
      xlab(expression(paste("Canopy cover (%)"))) +
      ylab("Tick abundance (log)") +
      def_theme

```

## Estimated host abundance
Log-log relationship
```{r tick-hosts}

ggplot(tick_data_sum, aes(log1p(avg_clusters1m), log1p(total_ticks), color = imcy_inv)) +
      geom_point() +
      invasion_color +
      invasion_fill +
      geom_smooth(aes(fill = imcy_inv), se = F, alpha = .2, method = "lm") +
      geom_smooth(aes(fill = imcy_inv), se = F, alpha = .2, method = "loess", linetype = "dashed") +
      geom_smooth(method = "lm", color = "gray50", se = F) +
      theme_classic() +
      xlab(expression(paste("Average # of dung clusters (log)"))) +
      ylab("Tick abundance (log)") +
      def_theme

```

Loess lines are dashed, lines from the linear model are solid, and the gray solid line is the overall trend when pooling the data across invaded and uninvaded plots.

# Initial/exploratory linear (OLS) models
```{r linear models ticks}
summary(lm(log1p(total_ticks) ~ years_since_fire, data = tick_data_sum))
summary(lm(log1p(total_ticks) ~ avg_litter_gm2, data = tick_data_sum))
summary(lm(avg_litter_gm2 ~ years_since_fire, data = tick_data_sum))
summary(lm(log1p(total_ticks) ~ avg_canopy_cover, data = tick_data_sum))
```

```{r ggpairs plot}
# install.packages("GGally")
library(GGally)
ggpairs(select(tick_data_sum, years_since_fire, ycoord_lat, total_ticks, avg_litter_gm2:avg_veg_cover, avg_pct_bare:avg_basal_area)) +
      theme(panel.grid = element_blank())

pairs(select(tick_data_sum, years_since_fire, ycoord_lat, total_ticks:avg_basal_area))
```


```{r path model structure}
library(piecewiseSEM)
library(lme4)
#glmmadmb

## Should make an explicit random-effect for the plot for clarity, by combining installation with plot_id

model_list <- list(
      tick_mod <- glmer.nb(total_ticks ~ avg_clusters1m + avg_pct_bare + avg_basal_area + years_since_fire + avg_veg_cover + (1|installation/plot_id), data = tick_data_sum),
      div_mod <- lm(log1p(richness) ~ years_since_fire, data = tick_data_sum),
      bare_grnd_mod <- lmer(avg_pct_bare ~ years_since_fire + (1|years_since_fire) + (1|installation), data = tick_data_sum),
      basal_area_mod <- lmer(avg_basal_area ~ years_since_fire + (1|years_since_fire) + (1|installation), data = tick_data_sum),
      # canopy_mod <- lmer(avg_canopy_cover ~ years_since_fire + + (1|installation) + (1|plot_id), data = tick_data_sum),
      lat_mod <- lmer(years_since_fire ~ ycoord_lat + (1|installation), tick_data_sum)
)

sem.fit(model_list, data = tick_data_sum, conditional = F)
sem.coefs(model_list, data = tick_data_sum, standardize = 'none')
sem.model.fits(model_list, aicc = T)
```


# Host abundance
We really just didn't find very much host evidence, and for the most part it is uniform across canopy cover.

```{r hosts-canopy-cover}

 ggplot(tick_data_sum, aes(avg_canopy_cover, log1p(avg_clusters1m))) +
      geom_point(aes(color = imcy_inv)) +
      invasion_color +
      geom_smooth(aes(color = imcy_inv), method = "lm", se = F) +
      theme_classic() +
      xlab(expression(paste("Canopy cover (%)"))) +
      ylab("Dung clusters (log)") +
      def_theme

```

```{r host-trees, eval=F}
ggplot(tick_data_sum, aes(avg_basal_area, log1p(avg_clusters1m))) +
      geom_point(aes(color = imcy_inv)) +
      invasion_color +
      geom_smooth(aes(color = imcy_inv), method = "loess", se = F) +
      theme_classic() +
      xlab(expression(paste("Canopy cover (%)"))) +
      ylab("Dung clusters (1m)") +
      def_theme
```


# Cogongrass Data Sampled from Invasions

```{r cogongrass data, eval=T}
cogon_data <- read_csv("data/raw_data/cogon-data.csv")
cogon_biomass <- cogon_data %>%
      # select(site,plot_id,Quad,fresh_biomass) %>%
      filter(site!="NA") %>%
      mutate(fresh_biomass_gm2 = fresh_biomass*16,
             dry_biomass_gm2 = dry_biomass*16)

d1 <- cogon_data %>% 
      mutate(avg_height = rowMeans(cbind(height1,height2,height3)),
             avg_width = rowMeans(cbind(width_1,width_2,width_3))) %>% 
      select(site:CogonSampleID,tiller_density,avg_height,avg_width) %>%
      mutate(est_leaf_area_cm = avg_height*avg_width*tiller_density,
             est_LAI = est_leaf_area_cm/10000)


cogon_ht <- cogon_data %>% 
      select(site:height3) %>% 
      mutate(id = as.integer(seq(1,23,1))) %>% 
      gather(key = fid, value = height_cm, -site, -plot_id, -Quadrant, -CogonSampleID, -id) %>% 
      select(-fid,-id)

cogon_width <- cogon_data %>% 
      select(site:CogonSampleID,width_1:width_3) %>% 
      mutate(id = as.integer(seq(1,23,1))) %>% 
      gather(key = fid, value = width_cm, -site, -plot_id, -Quadrant, -CogonSampleID, -id) %>% 
      select(width_cm)

cogon_ht_width <- bind_cols(cogon_ht, cogon_width) %>% 
      mutate(est_leaf_area_cm = height_cm*width_cm)
summary(cogon_ht_width)

cogon_leaf_area <- left_join(
      select(cogon_data, site:CogonSampleID,tiller_density),
      cogon_ht_width %>%
      group_by(site,plot_id,Quadrant,CogonSampleID) %>% 
      summarise(avg_est_leaf_area_cm = mean(est_leaf_area_cm))
) %>% 
      mutate(total_est_leaf_area = tiller_density*avg_est_leaf_area_cm,
             est_LAI = total_est_leaf_area/10000)

skimr::skim(cogon_leaf_area)
skimr::skim(d1)



cogon_biomass <- left_join(
      cogon_biomass,
      select(plot_visit_data, installation, visit_date, plot_id,years_since_fire, installation_full_name),
      by=c("site"="installation","plot_id"))

ggplot(cogon_biomass, aes(years_since_fire, fresh_biomass_gm2)) +
      geom_point(aes(color = installation_full_name), size = 2) +
      scale_color_brewer(palette = "Dark2") +
      theme_classic() +
      xlab("Years since fire") +
      ylab(expression(paste("Standing biomass fresh weight (g/", m^{2}, ")"))) +
      ggtitle("Cogongrass biomass") +
      def_theme
# ggsave("~/Dropbox (UF)/SERDP-Project/figures/cogon-biomass.png", height = 7)

```

To quantify cogongrass biomass, we collected samples of aboveground plant material in a 25cm x 25cm area. Up to three samples were collected in each invaded area in addition to sampling done as part of the larger plot. Maximum cogongrass biomass estimated from 25cm quadrat samples from invasions at DoD installations: `r max(cogon_biomass$biomass)`g/m^2^

```{r invaded-vs-uninvaded-biomass}

cogon_biomass_summary <- cogon_biomass %>% 
      group_by(site, plot_id, years_since_fire) %>% 
      summarise(avg_fresh_cogon_gm2 = mean(fresh_biomass_gm2, na.rm = T),
                avg_dry_cogon_gm2 = mean(dry_biomass, na.rm = T))
# biomass_data
# biomass_data_sub
# avg_biomass_data

cogon_biomass_summary <- left_join(
      cogon_biomass_summary, select(avg_biomass_data, installation:years_since_fire, avg_dry_standing_gm2, avg_standing_gm2 ),
      by = c("site"="installation","plot_id","years_since_fire")
)

library(tidyr)
biomass_comparison <- cogon_biomass_summary %>% 
      gather(biomass_type, biomass_weight, -site, -plot_id, -years_since_fire) %>% 
      mutate(biomass_type = if_else(biomass_type=="avg_fresh_cogon_gm2","Cogongrass (wet)",
                                    if_else(biomass_type=="avg_dry_cogon_gm2", "Cogongrass (dry)",
                                            if_else(biomass_type=="avg_standing_gm2", "Native (wet)", "Native (dry)")))) 
      # ungroup(.) %>% 
      # group_by(years_since_fire, biomass_type) %>% 
      # summarise(avg_biomass = mean(biomass_weight))
biomass_comparison$biomass_type <- factor(biomass_comparison$biomass_type, levels = c("Native (wet)", "Native (dry)", "Cogongrass (wet)","Cogongrass (dry)"))

ggplot(biomass_comparison, aes(years_since_fire, biomass_weight, color = biomass_type)) +
      geom_point() +
      geom_smooth(method = "loess", se = F) +
      # invasion_color +
      theme_classic() +
      def_theme +
      ylab(ylab(expression(paste("Fuel load (g/", m^{2}, ")")))) +
      xlab("Years since fire")

```

This is a quick and dirty estimate because there may be some overlap in the data. I need to clean up the calculation be separating out quadrats that have cogongrass in the plot data.

# Compare All Quadrat Data to Subset of Data

Percent cover

 * litter
 * bare ground
 * green

Heights

 * woody vegetation (3 measurements)
 * grassy/herbaceous vegetation (3 measurements)
 * litter (depth)
 
* If there was no vegetation or litter height to measure then the first vegetation measurement was assigned a value of zero and the other two `r NA`.


We (Drew and I) have been talking about the possibility of further reducing the amount of effort expended to sample vegetation and set up the plot by revising the plot design. 

**The alternative:** We use the 12.6m circular plot with just four vegetation sampling quadrats at 10 meters. Tick traps would be placed near the outside edge of the plot in each of the cardinal directions (north, east, south, west), and one in plot center.

**The caveats:** 1. Tick trap deployment and vegetation measurements would have to be on different days. 2. We still need to do transects for dung surveys.

My first step was to see how this plays out in the data by testing for differences in means of data summarized across all quadrats (12) to data from the quadrats at 10 meters (4). I subset the data and conducted a series of t-test on the means (averaging across all the 1 meter quadrats in each data set) of woody vegetation height, herbaceous vegetation height, litter depth; and percent covers of bare ground, green vegetation, and litter. 


```{r compare all 12 quadrats to subset of 4 at 10m }
par(mfrow=c(1,2))
hist(log(quadrat_summaries$avg_woody_ht1))
hist(log(quadrat10m_summaries$avg_woody_ht1))
t.test(log(quadrat_summaries$avg_woody_ht1),log(quadrat10m_summaries$avg_woody_ht1), var.equal = F)

hist(log(quadrat_summaries$avg_woody_ht_all))
var(log(quadrat_summaries$avg_woody_ht_all))
hist(log(quadrat10m_summaries$avg_woody_ht_all))
var(log(quadrat10m_summaries$avg_woody_ht_all))
t.test(log(quadrat_summaries$avg_woody_ht_all),log(quadrat10m_summaries$avg_woody_ht_all), var.equal = F)

hist(log(quadrat_summaries$avg_herb_ht1))
var(log(quadrat_summaries$avg_herb_ht1))
hist(log(quadrat10m_summaries$avg_herb_ht1))
var(log(quadrat10m_summaries$avg_herb_ht1))
t.test(log(quadrat_summaries$avg_herb_ht1),
       log(quadrat10m_summaries$avg_herb_ht1), var.equal = F)

hist(log(quadrat_summaries$avg_herb_ht_all))
var(log(quadrat_summaries$avg_herb_ht_all))
hist(log(quadrat10m_summaries$avg_herb_ht_all))
var(log(quadrat10m_summaries$avg_herb_ht_all))
t.test(log(quadrat_summaries$avg_herb_ht_all),
       log(quadrat10m_summaries$avg_herb_ht_all), var.equal = F)

hist(log(quadrat_summaries$avg_litter_depth1))
var(log(quadrat_summaries$avg_litter_depth1))
hist(log(quadrat10m_summaries$avg_litter_depth1))
var(log(quadrat10m_summaries$avg_litter_depth1))
t.test(log(quadrat_summaries$avg_litter_depth1),
       log(quadrat10m_summaries$avg_litter_depth1), var.equal = F)

hist(log(quadrat_summaries$avg_litter_depth_all))
var(log(quadrat_summaries$avg_litter_depth_all))
hist(log(quadrat10m_summaries$avg_litter_depth_all))
var(log(quadrat10m_summaries$avg_litter_depth_all))
t.test(log(quadrat_summaries$avg_litter_depth_all),
       log(quadrat10m_summaries$avg_litter_depth_all), var.equal = T)

hist((quadrat_summaries$avg_pct_green))
var((quadrat_summaries$avg_pct_green))
hist((quadrat10m_summaries$avg_pct_green))
var((quadrat10m_summaries$avg_pct_green))
t.test((quadrat_summaries$avg_pct_green),
       (quadrat10m_summaries$avg_pct_green), var.equal = F)

hist(log(quadrat_summaries$avg_pct_litter))
var(log(quadrat_summaries$avg_pct_litter))
hist(log(quadrat10m_summaries$avg_pct_litter))
var(log(quadrat10m_summaries$avg_pct_litter))
t.test(log(quadrat_summaries$avg_pct_litter),
       log(quadrat10m_summaries$avg_pct_litter), var.equal = F)

hist(log1p(quadrat_summaries$avg_pct_bare))
var((quadrat_summaries$avg_pct_bare))
hist(log1p(quadrat10m_summaries$avg_pct_bare))
var((quadrat10m_summaries$avg_pct_bare))
t.test(log1p(quadrat_summaries$avg_pct_bare),
       log1p(quadrat10m_summaries$avg_pct_bare), var.equal = F)
```

Using all 12 qudrats we have `r n_distinct(species_data$veg_id)` species, while using the four quadrats at 10 meters we have `r n_distinct(species_sub$veg_id)` species. This suggests a major difference in species richness, however, some of these are as yet unidentified/grouped and are likely duplicates for both data sets. 

```{r t-test species cover quadrat subset}
## Testing for differences in dense vs. less dense data collection
hist(log(species_data$pct_cover))
var(log(species_data$pct_cover))
hist(log(species_sub$pct_cover))
var(log(species_sub$pct_cover))
t.test(log(species_data$pct_cover), log(species_sub$pct_cover),
       var.equal = T, paired = F)
```
A t-test of the log-transformed means for percent cover indicate no statistical difference.

Based on these t-tests there were no statistical differences in the means of these variables aggregated to the plot level. 
