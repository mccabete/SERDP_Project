---
title: "Light Curves"
output: html_notebook
---

 
# Setup
```{r}
## Libraries
library(dplyr)
library(ggplot2)
library(rjags)

## Read in raw data
light_flist <- list()
light_flist <- list.files("/Users/tess/Documents/work/SERDP_Project/Cogongrass_trait_sampling/Light_curves/")
raw_data_light <- list()
humidity_raw <- read.csv2("/Users/tess/Documents/work/SERDP_Project/Cogongrass_trait_sampling/humidity_curves/tess-humidity-curve-1", skip = 12, header = TRUE, sep = "\t", stringsAsFactors = FALSE)

humidity_1500 <- humidity_raw[humidity_raw$PARi >= 1430 & humidity_raw$PARi <= 1530, ]
humidity_400 <- humidity_raw[humidity_raw$PARi >= 330 & humidity_raw$PARi <= 530, ]
  
problem_files <- c("tess-ex-leaf-2","tess-ex-leaf-3", "Light_curves_fitting.nb.html",  "Light_curves_fitting.Rmd",  "tess-ex-leaf-4",  "tess-feild-curve-7")

good_i_values <- c()
for (i in seq_along(light_flist)){
  print(i)
  if(!(light_flist[i] %in% problem_files)){
    good_i_values <-c(good_i_values, i)
    file_path <- paste("/Users/tess/Documents/work/SERDP_Project/Cogongrass_trait_sampling/Light_curves/", light_flist[i], sep= "")
    raw_data_light[[i]] <- read.csv2(file_path, skip = 12, header = TRUE, sep = "\t", stringsAsFactors = FALSE)
  }
}


## Do QA/QC on data (by hand)
 tmp<- raw_data_light[[3]]
 tmp$Name <- light_flist[[3]]
 tmp$type <- "ex"
 raw_data_light[[3]] <- tmp[-c(1,4, 13:26), ]
 
 tmp<- raw_data_light[[7]]
 tmp$Name <- light_flist[[7]]
 tmp$type <- "ex"
 raw_data_light[[7]] <- tmp[-c(8,10), ]
 
 tmp<- raw_data_light[[8]]
 tmp$Name <- light_flist[[8]]
 tmp$type <- "field"
 raw_data_light[[8]] <- tmp
 
 tmp<- raw_data_light[[9]]
 tmp$Name <- light_flist[[9]]
 tmp$type <- "field"
 raw_data_light[[9]] <- tmp
 
 tmp<- raw_data_light[[10]]
 tmp$Name <- light_flist[[10]]
 tmp$type <- "field"
 raw_data_light[[10]] <- tmp[-c(18),]
 
 tmp<- raw_data_light[[12]]
 tmp$Name <- light_flist[[12]]
 tmp$type <- "field"
 raw_data_light[[12]] <- tmp
 
 tmp<- raw_data_light[[13]]
 tmp$Name <- light_flist[[13]]
 tmp$type <- "field"
 raw_data_light[[13]] <- tmp
 
 tmp<- raw_data_light[[14]]
 tmp$Name <- light_flist[[14]]
 tmp$type <- "field"
 raw_data_light[[14]] <- tmp[-c(1), ]
 
 tmp<- raw_data_light[[15]]
 tmp$Name <- light_flist[[15]]
 tmp$type <- "field"
 raw_data_light[[15]] <- tmp[-c(1), ]
 
 tmp<- raw_data_light[[16]]
 tmp$Name <- light_flist[[16]]
 tmp$type <- "field"
 raw_data_light[[16]] <- tmp[-c(17, 19, 21,22), ]
 
 tmp<- raw_data_light[[17]]
 tmp$Name <- light_flist[[17]]
 tmp$type <- "field"
 raw_data_light[[17]] <- tmp
 
 ## get low photosynthesis curves and remove
low_photosytheis <- c()
for ( i in seq_along(good_i_values)){
  index <- good_i_values[i]
  print(index)
  if(max(as.numeric(as.matrix(raw_data_light[[index]]$Photo))) <= 2){
    low_photosytheis <- c(low_photosytheis,unique(raw_data_light[[index]]$Name) )
  }
}

light_curves <- list()
for (i in seq_along(good_i_values)){
  if(!(unique(raw_data_light[[good_i_values[i]]]$Name) %in% low_photosytheis)){
    light_curves[[i]] <- raw_data_light[[good_i_values[i]]]
  }
}


```

## Exploratory data analysis

I am trying to asses the quality of my curves by plotting a line of g_s vs A/(c*(1+ VPD/D_0)). The notation is different, but is from equation 89 in the [model-write-up of ED2](https://www.geosci-model-dev-discuss.net/gmd-2019-45/gmd-2019-45.pdf). The Default value for c4 plants is  0.016, and can be found in the supplement. X in this code chunk referes to the result of A/ (c(1+ VPD/D_0)).


Note, it looks like VPD returned from the licore is in kPa and that the ratio is ED2 is mol w : mol. If I manually change D to two, I get a better looking graph. 
```{r}

## Figure out how big this dataframe needs to be 
test_length <- 0
for (i in seq_along(light_curves)){
  for (j in seq_along(light_curves[[i]]$Photo)){
    test_length <- test_length + 1
  }
}
print(test_length)

stomatal_conductance <- matrix(data = NA, nrow = test_length+1, ncol = 4)
stomatal_conductance <- as.data.frame(stomatal_conductance, stringsAsFactors = FALSE)
names(stomatal_conductance) <- c("gs", "X", "type", "Name")


#D_0 <- 0.016 in ED2 bu clearly the wrong units 
D_0 <- 0.016 #When using kPa changed to 2
## Make into one data table
test_length <- 0
for (i in seq_along(light_curves)){
  for (j in seq_along(light_curves[[i]]$Photo)){
    test_length <- test_length + 1
    g_s <- as.numeric(light_curves[[i]]$Cond[j])
    vpd <- (as.numeric(light_curves[[i]]$H2OS[j]) - as.numeric(light_curves[[i]]$H2OR[j]) )
    vpd <- vpd * 0.001
    A <- as.numeric(light_curves[[i]]$Photo[j])
    Ca <- as.numeric(light_curves[[i]]$CO2S[j])
    name <-light_curves[[i]]$Name[1]
    type <-light_curves[[i]]$type[1]
    
    ## calculation of X
    X <- A/(Ca*(1+(vpd/D_0)))
    stomatal_conductance$gs[test_length] <- g_s
    stomatal_conductance$X[test_length] <- X
    stomatal_conductance$type[test_length] <- type
    stomatal_conductance$Name[test_length] <- name
    stomatal_conductance$vpd <-  as.numeric(light_curves[[i]]$VpdL[j])
    stomatal_conductance$A <- as.numeric(light_curves[[i]]$Photo[j])
    stomatal_conductance$Ca <- as.numeric(light_curves[[i]]$CO2S[j])
  }
}

stomatal_conductance <- stomatal_conductance[stomatal_conductance$Name != "tess-feild-9", ]

```


# Plotting
```{r}


ggplot(data= stomatal_conductance) +
  geom_point( aes(x = X, y = gs, color = Name))


## I was worried that tess-ex-leaf-5 was actually a ex curve with a feild curve on top of it. 

for ( i in seq_along(light_curves)){
  plot(x = light_curves[[i]]$Obs, y = light_curves[[i]]$Photo)
title(light_curves[[i]]$Name[i])
}

## HUmidity curves 
plot( x = humidity_1500$Obs, y = humidity_1500$Photo)
title("Humidity Curve PAR = 1500")
plot( x = humidity_400$Obs, y = humidity_400$Photo)
title("Humidity Curve PAR = 400")

```

```{r}

### Trying to just get the first 7 values of every file
first_curve_only <- matrix(data = NA, nrow = length(light_curves)*7, ncol = 4)
first_curve_only <- as.data.frame(first_curve_only, stringsAsFactors = FALSE)
names(first_curve_only) <- c("gs", "X", "type", "Name")
test_length <- 0
for (i in seq_along(light_curves)){
  for (j in 1:7){
    test_length <- test_length + 1
    g_s <- as.numeric(light_curves[[i]]$Cond[j])
    vpd <- (as.numeric(light_curves[[i]]$H2OS[j]) - as.numeric(light_curves[[i]]$H2OR[j]) )
    vpd <- vpd * 0.001
    A <- as.numeric(light_curves[[i]]$Photo[j])
    Ca <- as.numeric(light_curves[[i]]$CO2S[j])
    name <-light_curves[[i]]$Name[1]
    type <-light_curves[[i]]$type[1]
    
    ## calculation of X
    X <- A/(Ca*(1+(vpd/D_0)))
    first_curve_only$gs[test_length] <- g_s
    first_curve_only$X[test_length] <- X
    first_curve_only$type[test_length] <- type
    first_curve_only$Name[test_length] <- name
    first_curve_only$vpd <-  as.numeric(light_curves[[i]]$VpdL[j])
    first_curve_only$A <- as.numeric(light_curves[[i]]$Photo[j])
    first_curve_only$Ca <- as.numeric(light_curves[[i]]$CO2S[j])
  }
}

first_curve_only <- first_curve_only[first_curve_only$Name != "tess-feild-9", ]
first_curve_only <- first_curve_only[first_curve_only$Name != "tess-ex-leaf-1", ]
stomatal_conductance <- stomatal_conductance[stomatal_conductance$Name != "tess-ex-leaf-1",]

ggplot(data= first_curve_only) +
  geom_point( aes(x = X, y = gs, color = Name))+
  ggtitle("Only First Curve")

ggplot(data= stomatal_conductance) +
  geom_point( aes(x = X, y = gs, color = Name))+
  ggtitle("All points")

```

## Trying to get just the points on full curves
```{r}
full_curve <- matrix(data = NA, nrow = 72, ncol = 4)
full_curve <- as.data.frame(full_curve, stringsAsFactors = FALSE)
names(full_curve) <- c("gs", "X", "type", "Name")

seven_good <- c("tess-feild-2", "tess-feld-light-curve-1", "tess-ex-leaf-1")
forteen_good <- c( "tess-feild-3", "tess-feild-curve-8")
nine_good <- c("tess-feild-curve-9")
zero_good <- c("tess-feild-9")
seven_to_forteen <- c("tess-ex-leaf-5")


last_good_point <- NA
test_length <- 0
for (i in seq_along(light_curves)){
  
  first_good_point <- 1
  if (light_curves[[i]]$Name[1] %in% seven_good){
    last_good_point <- 7
  }
  if (light_curves[[i]]$Name[1] %in% forteen_good){
    last_good_point <- 14
  }
  if (light_curves[[i]]$Name[1] %in% nine_good){
    last_good_point <- 9
  }
  if (light_curves[[i]]$Name[1] %in% zero_good){
    first_good_point <- 7
    last_good_point <- 14
  }
  if (light_curves[[i]]$Name[1] %in% zero_good){
    next
  }
  
  for (j in first_good_point:last_good_point){
    test_length <- test_length + 1
    g_s <- as.numeric(light_curves[[i]]$Cond[j])
    vpd <- (as.numeric(light_curves[[i]]$H2OS[j]) )# - as.numeric(light_curves[[i]]$H2OR[j]) )
    vpd <- vpd * 0.001
    A <- as.numeric(light_curves[[i]]$Photo[j])
    Ca <- as.numeric(light_curves[[i]]$CO2S[j])
    name <-light_curves[[i]]$Name[1]
    type <-light_curves[[i]]$type[1]
    
    ## calculation of X
    X <- A/(Ca*(1+(vpd/D_0)))
    full_curve$gs[test_length] <- g_s
    full_curve$X[test_length] <- X
    full_curve$type[test_length] <- type
    full_curve$Name[test_length] <- name
    full_curve$vpd[test_length] <- vpd
    full_curve$A[test_length] <- as.numeric(light_curves[[i]]$Photo[j])
    full_curve$Ca[test_length] <- as.numeric(light_curves[[i]]$CO2S[j])
  }
}
full_curve <- full_curve[full_curve$Name != "tess-feild-9", ]
full_curve <- full_curve[full_curve$Name != "tess-ex-leaf-1", ]

#full_curve <- full_curve[-c(5:7), ]

ggplot(data= first_curve_only) +
  geom_point( aes(x = X, y = gs, color = Name))+
  ggtitle("Only First Curve")

ggplot(data = full_curve) + 
  geom_point( aes(x = X, y = gs, color = Name))+
  ggtitle("Full Curve - only feild curves")

ggplot(data= stomatal_conductance) +
  geom_point( aes(x = X, y = gs, color = Name))+
  ggtitle("All points")
```

## Add in Humidity curves

```{r}

for (j in seq_along(humidity_1500)){
   
    g_s <- as.numeric(humidity_1500$Cond[j])
    vpd <- (as.numeric(humidity_1500$H2OS[j]) - as.numeric(humidity_1500$H2OR[j]) )
    vpd <- vpd * 0.001
    A <- as.numeric(humidity_1500$Photo[j])
    Ca <- as.numeric(humidity_1500$CO2S[j])
    name <- "humidity_1500"
    type <- "humidity"
    
    ## calculation of X
    X <- A/(Ca*(1+(vpd/D_0)))
    humidity_1500$gs[j] <- g_s
    humidity_1500$X[j] <- X
    humidity_1500$type[j] <- type
    humidity_1500$Name[j] <- name
    humidity_1500$vpd[j] <-  vpd
    humidity_1500$A[j] <- as.numeric(humidity_1500$Photo[j])
    humidity_1500$Ca[j] <- as.numeric(humidity_1500$CO2S[j])
  }

for (j in seq_along(humidity_400)){
   
    g_s <- as.numeric(humidity_400$Cond[j])
    vpd <- (as.numeric(humidity_400$H2OS[j]) - as.numeric(humidity_400$H2OR[j]) )
    vpd <- vpd * 0.001
    A <- as.numeric(humidity_400$Photo[j])
    Ca <- as.numeric(humidity_400$CO2S[j])
    name <- "humidity_400"
    type <- "humidity"
    
    ## calculation of X
    X <- A/(Ca*(1+(vpd/D_0)))
    humidity_400$gs[j] <- g_s
    humidity_400$X[j] <- X
    humidity_400$type[j] <- type
    humidity_400$Name[j] <- name
    humidity_400$vpd[j] <-  vpd
    humidity_400$A[j] <- as.numeric(humidity_400$Photo[j])
    humidity_400$Ca[j] <- as.numeric(humidity_400$CO2S[j])
  }


ggplot(data = full_curve) + 
  geom_point( aes(x = X, y = gs, color = Name))+
  geom_point(data = humidity_1500, aes(jitter(x=humidity_1500$X), y = humidity_1500$gs, color = "humidity 1500"))+ 
  geom_point(data = humidity_400, aes(x=humidity_400$X, y = humidity_400$gs, color = "Humidity 400"))+ 
  ggtitle("Full Curve - only feild curves")


```

## Trying to fit it in JAGS

```{r}

# get estimates of parameters from sensitivity analysis
load("/Users/tess/Documents/work/cogognrass/sensitivity.results.NOENSEMBLEID.NPP.2017.2018.Rdata")
stomatal_slope_average <- mean(sensitivity.results$cogongrass2$sensitivity.output$sa.samples$stomatal_slope)
stomatal_slope_var <- var(sensitivity.results$cogongrass2$sensitivity.output$sa.samples$stomatal_slope)


run_stomatal_slope_fit <- function(temp_data, leaf_name, n.iter = 6000){
Stomtal_slope = "
model{
  
    D_0_corrected <- D_0 + 0.000001 # To avoid deviding by zero issues
  for (i in 1:num_points){
    #### Process Model
    X[i] <- A[i]/(Ca[i]*(1+(vpd[i]/D_0_corrected)))
    mu[i] <- min_conductance + m*X[i]
    gs[i] ~ dnorm(mu[i], precision)
  }
  
  
  #### Priors
  D_0 ~ dgamma(1.19999, 90) # from ED2 default (0.016), and conversation with Mike (max)
  m ~ dnorm(stomatal_slope_average, 1/stomatal_slope_var) # Roughtly get from sensitivity analysis 
  min_conductance ~ dgamma(1.5, 10) ## No clue. I looked at *Optimal stomatal behaviour around the world* which didn't have numbers for g_0 and argued that should just be minimun bound. I am doing a gamma with some varience. 
 precision ~ dgamma(1, 2) ## Guessing
}
"


data <- list(num_points = length(temp_data$gs), 
             A = temp_data$A,
             Ca = temp_data$Ca, 
             vpd = temp_data$vpd,
             gs = temp_data$gs, 
             stomatal_slope_var = stomatal_slope_var,
             stomatal_slope_average = stomatal_slope_average)

nchain = 3
init <- list()
for(i in 1:nchain){
  init[[i]] <- list(m = 0.5, D_0 = 0.016, min_conductance = 0.001)
}


j.model   <- jags.model (file = textConnection(Stomtal_slope),
                             data = data,
                             inits = init,
                             n.chains = 3)

jags.out   <- coda.samples (model = j.model,
                            variable.names = c("m","min_conductance","D_0", "precision"),
                                n.iter = n.iter)
GBR <- gelman.plot(jags.out)
burnin <- GBR$last.iter[tail(which(apply(GBR$shrink[,,2]>1.05,1,any)),1)+1]
if(is.na(burnin)){
  warning("GBR !< 1.05. Model may have failed to converge")
  jags.burn <- jags.out
  did_it_converge <- "convergence_failed_GBR_test" 
}else{
  did_it_converge <- "convergence_passed_GBR_test"
  jags.burn <- window(jags.out,start=burnin, extend = FALSE)
}
  date_stamp <- Sys.time()
  date_stamp <- format(date_stamp, "%Y%m%d")
  file_name <- paste("/Users/tess/Documents/work/SERDP_Project/Cogongrass_trait_sampling/Jags_output/", date_stamp, ".", "Stomatal_slope_of",".",leaf_name,".", did_it_converge, ".","JAGS_run.Rdata", sep = "")
  print(did_it_converge)
  print(effectiveSize(jags.burn))
  save(jags.burn, file = file_name )
  #return(jags.burn)
}

### Testing function
#temp_data <- dplyr::filter(full_curve, Name == "tess-feild-3")
#run_stomatal_slop_fit(temp_data = temp_data, leaf_name = "tess-feild-3", n.iter = 6000 )
#effectiveSize(jags.burn)

## Loop over each file (corresponding to each leaf)
leaves <- unique(full_curve$Name)
leaves <- leaves[!is.na(leaves)]

for ( i in seq_along(leaves)){
  temp_data <- dplyr::filter(full_curve, Name == leaves[i])
  run_stomatal_slop_fit(temp_data = temp_data, leaf_name = leaves[i], n.iter = 6000 )
 
}

```

## How much agreement is there in what stomatal slope is? 
- Look at different density estimates? 
- compare to previous ED2 sensitivity output? 

```{r}
jags_list <- list.files()

```


